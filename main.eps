import ETK.ETKUnit as Unit;
import ETK.ETKUtils as Utils;
import ETK.ETKTimer as Timer;
import ETK.ETKConstants as Const;
import ETK.ETKCommon as Common;
import Balance;
import Waves;
import Towers;

const Screen = StringBuffer(256);
const MouseLeftButtonPress = EUDArray(6);
const MouseLeftButtonDown = EUDArray(6);
const MouseRightButtonPress = EUDArray(6);
const MouseRightButtonDown = EUDArray(6);
const MouseMiddleButtonPress = EUDArray(6);
const KeyQDown = EUDArray(6);
const KeyPDown = EUDArray(6);
const KeyUDown = EUDArray(6);

const PlacementLocation = $L("Placement");

// TODO replace with objects

const PlayerWeaponIndex = EUDArray(6);
const PlayerWeaponCooldown = EUDArray(6);
const PlayerSelectedUnit = EUDArray(6);

const MouseLoc = [
	$L("MouseLoc1"),
	$L("MouseLoc2"),
	$L("MouseLoc3"),
	$L("MouseLoc4"),
	$L("MouseLoc5"),
	$L("MouseLoc6")
];

const SelectionAddresses = [
	0x6284E8,
	0x628518,
	0x628548,
	0x628578,
	0x6285A8,
	0x6285D8
];


const SelectedUnitID = EUDArray(6);

function updateSelectedUnit(playerID) {
	const address = SelectionAddresses[playerID];
	const ptr = dwread(address);
	const epd = EPD(ptr);
	if (ptr != 0) {
		SelectedUnitID[playerID] = epd;
	} else {
		SelectedUnitID[playerID] = 0;
	}
}

function refreshSelection(playerID) {
	PlayerSelectedUnit[playerID] = 0;
}

function initMap() {
	EUDRegisterObjectToNamespace("MouseLeftButtonPress", MouseLeftButtonPress);
	EUDRegisterObjectToNamespace("MouseLeftButtonDown", MouseLeftButtonDown);
	EUDRegisterObjectToNamespace("MouseRightButtonPress", MouseRightButtonPress);
	EUDRegisterObjectToNamespace("MouseRightButtonDown", MouseRightButtonDown);

	EUDRegisterObjectToNamespace("MouseMiddleButtonPress", MouseMiddleButtonPress);
	EUDRegisterObjectToNamespace("KeyQDown", KeyQDown);
	EUDRegisterObjectToNamespace("KeyPDown", KeyPDown);
	EUDRegisterObjectToNamespace("KeyUDown", KeyUDown);
	Towers.load();
}

function onPluginStart() {
	randomize();
	initMap();
	Utils.setup();
}

function beforeTriggerExec() {
	Utils.EUDTurbo();
	Timer.tick();
	EUDPlayerLoop()();
	if (getcurpl() < $P7) {
		const playerID = getcurpl();
		updateSelectedUnit(playerID);
		const selectedUnit = SelectedUnitID[playerID];
		const mouseLocation = MouseLoc[playerID];

		// TOGGLING MOBS
		if (KeyPDown[playerID]) {
			SetSwitch((0), (6));
		}

		// TOWERS ACTIVE
		foreach(ptr, unit : EUDLoopPlayerUnit(playerID)) {
			if (Unit.getUnitType(unit) == Const.Unit_TerranBeacon) {

				Towers.updateTower(unit);

				const towerUnit = unit;
				const towerType = Towers.getTowerType(Unit.getCustomValue(towerUnit));

				// Upgrading
				const queueUnitType = Unit.getBuildQueue1(towerUnit);
				if (Unit.getBuildQueueLength(towerUnit) > 0) {
					Unit.clearBuildQueue(towerUnit);
				}

				if (queueUnitType == 99) {
					const cannonUnit = Unit.getConnectedUnit(towerUnit);
					Utils.removeUnit(towerUnit);
					Utils.removeUnitSafe(cannonUnit);
					refreshSelection(playerID);
				} else if (queueUnitType >= 100 && queueUnitType <= 105) {
					Unit.setRankIncrease(towerUnit, Unit.getRankIncrease(towerUnit)+1);
					refreshSelection(playerID);
				}

				//Firing
				if (Unit.getGroundWeaponCooldown(towerUnit) > towerType.data.baseCooldown) {
					Unit.setGroundWeaponCooldown(towerUnit, towerType.data.baseCooldown);		
				}

				if (Unit.getGroundWeaponCooldown(towerUnit) == 0
					&& Unit.getOrder(towerUnit) == Const.Order_Attack_Building
					&& Unit.isOrderTargetUnitValid(towerUnit)) {
					Towers.towerFire(towerUnit);
					Unit.setGroundWeaponCooldown(towerUnit, towerType.data.baseCooldown);	
				}
			}
		}

		// PLACING TOWERS
		if (selectedUnit != 0 && Unit.getUnitType(selectedUnit) == Const.Unit_KhaydarinCrystalFormation) {
			if (Unit.getOrder(selectedUnit) == Const.Order_Build_SCV) {
				var x, y = Utils.getLocationPoint(MouseLoc[playerID]);
				var roundedX = ((x / 32) * 32) + 32;
				var roundedY = ((y / 32) * 32) + 32;
			    Utils.centerLocationOnPoint(PlacementLocation, roundedX, roundedY, 64, 64);
				Towers.createBaseTower(PlacementLocation, playerID);
    			Unit.setOrder(selectedUnit, Const.Order_Nothing2_Normal);
			}
		}

		// SELECTING TOWERS
		if (selectedUnit != 0 && Unit.getUnitType(selectedUnit) == Const.Unit_TerranFlagBeacon) {
			const queueUnitType = Unit.getBuildQueue1(selectedUnit);
			if (queueUnitType != Const.Unit_None) {
				Towers.setTowerType(selectedUnit, queueUnitType);
				Unit.clearBuildQueue(selectedUnit);
			}
		}


		// TOWERS DISPLAY
		if (selectedUnit != 0 && Unit.getUnitType(selectedUnit) == Const.Unit_TerranBeacon) {
			if (PlayerSelectedUnit[playerID] != selectedUnit) {

				if (IsUserCP()) {
					Utils.setUpgrade(7, Unit.getRankIncrease(selectedUnit), playerID);
					Utils.setUnitWeapon(Const.Unit_TerranBeacon, Unit.getCustomValue(selectedUnit));
				}

				Utils.setUnitCost(100 + playerID, 10 + Unit.getRankIncrease(selectedUnit) * 10);

				PlayerSelectedUnit[playerID] = selectedUnit;
				Unit.setStatusFlags(selectedUnit, 0x04340008);
				Timer.add(0, selectedUnit, EUDFuncPtr (2, 0) (function(callbackUnit, intervalCount) {
					Unit.setStatusFlags(callbackUnit, 0x04340003);
				}));
			}

			if (false) {
				Screen.printfAt(1,
					"O = {}, V? TU {}",
					Unit.getOrder(selectedUnit),
					Unit.isOrderTargetUnitValid(selectedUnit),
					Common.PTR(Unit.getOrderTargetUnit(selectedUnit))
				);
			}
		}
	}
	EUDEndPlayerLoop();

	// Missiles
	foreach(ptr, unit : EUDLoopPlayerUnit(P8)) {
		if (Unit.getUnitType(unit) == Const.Unit_ProtossObserver) {

			const targetUnit = Unit.getTargetUnit(unit);
			if (Unit.isOrderTargetUnitValid(unit)) {
				const uX, uY = Unit.getPosition(unit);
				const tX, tY = Unit.getPosition(targetUnit);
				Unit.setOrder(unit, Const.Order_Ignore_Normal);
				Unit.setOrderTargetX(unit, tX);
				Unit.setOrderTargetY(unit, tY);
				// Unit.setTargetUnit(unit, targetUnit);
				if (Utils.abs(uX-tX) < 32 && Utils.abs(uY-tY) < 32) {
					Towers.missileHit(unit);
				}
			} else {
				Utils.removeUnit(unit);
			}
		}
		if (Unit.getUnitType(unit) == Utils.OVERLAY_SPRITE_UNIT_TYPE) {
			Utils.updateOverlay(unit);
		}
	}

	foreach(ptr, unit : EUDLoopPlayerUnit(P7)) {
		if (true) {
            Unit.setStatusFlags(unit, 0x00230005); // 5xxxx does not move, 3xxxx crashes


			// Hack for now, implement with timer later
			Unit.set106Flag(unit, Unit.get106Flag(unit) + 1);
			if (Unit.get106Flag(unit) > 12) {
				Unit.set106Flag(unit, 0);
				Unit.setKillCount(unit, Unit.getKillCount(unit) + 1);				
			}

			const maxHP = Unit.getMaxHitpoints(unit);
			const hp = Unit.getHitpoints(unit);
			const fraction = maxHP / 4;
			if (hp == maxHP) {
				Utils.setUnitColor(unit, 8);
			} else if (hp > fraction*3) {
				Utils.setUnitColor(unit, $P8);
			} else if (hp > fraction*2) {
				Utils.setUnitColor(unit, $P5);
			} else {
				Utils.setUnitColor(unit, $P1);
			}
		}
	}

	if (Switch(0, 2) && Bring($P7, Exactly, 0, Const.Unit_AnyUnit, $L("P1Track1"))) {
		if (Waves.SpawnCooldown[$P1] == 0) {
			Waves.SpawnCooldown[$P1] = 6;
			const nextUnitType = Waves.GetNextSpawnUnitForWave(Waves.Wave100);
			if (nextUnitType != Const.Unit_None) {
				const u = Utils.createUnit(nextUnitType, $L("P1Track1"), $P7);
				Unit.setStatusFlags(u, 0x00230005); // 5xxxx does not move, 3xxxx crashes	
			}
		} else {
			Waves.SpawnCooldown[$P1]--;
		}
	}
}