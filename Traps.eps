import ETK.ETKUnit as Unit;
import ETK.ETKUtils as Utils;
import ETK.ETKTimer as Timer;
import ETK.ETKConstants as Const;
import ETK.ETKCommon as Common;

const TRAP_OBJ = EUDArray(64);
var TRAP_COUNT = 0;
const pp = StringBuffer(256);

object TrapType {
    var id;
    var spriteImageID;
    var projectileImageID;
    var hitImageID;
    var fire: EUDFuncPtr (1, 0);
    var hit: EUDFuncPtr (1, 0);
    var baseDamage;
    var cooldown;
};

function getTrap(id): TrapType {
    return TRAP_OBJ[id];
}

function isTrapValid(id) {
    return getTrap(id) != 0 && id < TRAP_COUNT;
}

function addTrap(Trap : TrapType, id) {
    Trap.id = id;
    TRAP_OBJ[id] = Trap;
}

function addTowerObj(id, spriteImageID, projectileImageID, hitImageID, fireFunction, baseDamage, cooldown) {
    const trap = TrapType.alloc();
    trap.spriteImageID = spriteImageID;
    trap.projectileImageID = projectileImageID;
    trap.hitImageID = hitImageID;
    trap.fire = fireFunction;
    trap.baseDamage = baseDamage;
    trap.cooldown = cooldown;
    addTrap(trap, id);
}

function addTrapObj(id, spriteImageID, projectileImageID, fireFunction, baseDamage, cooldown) {
    const trap = TrapType.alloc();
    trap.spriteImageID = spriteImageID;
    trap.projectileImageID = projectileImageID;
    trap.fire = fireFunction;
    trap.baseDamage = baseDamage;
    trap.cooldown = cooldown;
    addTrap(trap, id);
}

function missileHit(missileUnit) {
    const targetUnit = Unit.getTargetUnit(missileUnit);
    const trapUnit = Unit.getConnectedUnit(missileUnit);
    const tower = getTrap(Unit.getCustomValue(trapUnit));
    Utils.createImageSpriteAtUnitPosition(tower.hitImageID, targetUnit);
    const damage = tower.baseDamage + tower.baseDamage * Unit.getRankIncrease(trapUnit);
    if (Unit.damage(targetUnit, damage)) {
        SetResources(Unit.getPlayerID(trapUnit), (8), Utils.getUnitDestroyValue(Unit.getUnitType(targetUnit)), (0));
    }
    Utils.removeUnit(missileUnit);
}

function loadTraps() {

    const defaultFire = EUDFuncPtr (1, 0) (function(trapUnit) {
        const trap = getTrap(Unit.getCustomValue(trapUnit));
        const targetUnit = Unit.getTargetUnit(trapUnit);
        Utils.createImageSpriteAtUnitPosition(trap.projectileImageID, targetUnit);
        const damage = trap.baseDamage + trap.baseDamage * Unit.getRankIncrease(trapUnit);
        if (Unit.damage(targetUnit, damage)) {
            SetResources(Unit.getPlayerID(trapUnit), (8), Utils.getUnitDestroyValue(Unit.getUnitType(targetUnit)), (0));
        }
    });

    const defaultMissileFire = EUDFuncPtr (1, 0) (function(trapUnit) {
        const trap = getTrap(Unit.getCustomValue(trapUnit));
        const targetUnit = Unit.getTargetUnit(trapUnit);
        Utils.moveUtilLocationToUnit(trapUnit);
        const missileUnit = Utils.createUnit(Const.Unit_ProtossObserver, Utils.UTILITY_LOCATION, Unit.getPlayerID(trapUnit));
        Unit.setConnectedUnit(missileUnit, trapUnit);
        Unit.setOrder(missileUnit, Const.Order_Ignore_Normal);
        Unit.setTargetUnit(missileUnit, targetUnit);
    });

    const defaultMissileHit = EUDFuncPtr (1, 0) (function(missileUnit) {
    });

    addTrapObj(
        0,
        Const.Image_Stasis_Field_Hit,
        Const.Image_Hallucination_Death3,
        EUDFuncPtr (1, 0) (function(trapUnit) {
            const trap = getTrap(Unit.getCustomValue(trapUnit));
            const targetUnit = Unit.getTargetUnit(trapUnit);
            Utils.createImageSpriteAtUnitPosition(trap.projectileImageID, targetUnit);
            Unit.damage(targetUnit, trap.baseDamage);
            Unit.setTopSpeed(targetUnit, Unit.getOriginalTopSpeed(targetUnit) / 4);
        }),
        5,
        24
    );

    addTowerObj(
        1,
        Const.Image_Maelstrom_Hit,
        Const.Image_Flames1_Type2_Large,
        Const.Image_Corrosive_Acid_Hit,
        defaultMissileFire,
        5,
        6
    );

    /*
    addTrapObj(
        1,
        Const.Image_Maelstrom_Hit,
        Const.Image_Flames1_Type2_Large,
        defaultFire,
        5,
        6
    );
    */

    addTrapObj(
        2,
        Const.Image_Egg_Spawn,
        Const.Image_Sunken_Colony_Tentacle,
        defaultFire,
        34,
        18
    );

    addTrapObj(
        3,
        Const.Image_Venom_Hit_Unused,
        Const.Image_Infested_Terran_Explosion,
        defaultFire,
        34,
        18
    );

    addTrapObj(
        5,
        Const.Image_EMP_Shockwave_Hit_Part1,
        Const.Image_Subterranean_Spines,
        defaultFire,
        34,
        18
    );

    addTrapObj(
        7,
        Const.Image_Hallucination_Hit,
        Const.Image_Psionic_Shockwave_Hit,
        defaultFire,
        34,
        18
    );

    addTrapObj(
        8,
        Const.Image_Ensnare_Overlay_Large,
        Const.Image_Ensnare_Overlay_Medium,
        defaultFire,
        34,
        18
    );

    addTrapObj(
        9,
        Const.Image_Explosion1_Small,
        Const.Image_Unused_Heal_Medium,
        defaultFire,
        34,
        18
    );
}