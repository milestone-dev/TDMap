import ETK.ETKUnit as Unit;
import ETK.ETKUtils as Utils;
import ETK.ETKTimer as Timer;
import ETK.ETKConstants as Const;

const TRAP_OBJ = EUDArray(64);
var TRAP_COUNT = 0;
const pp = StringBuffer(256);

object TrapType {
    var id;
    var spriteImageID;
    var projectileImageID;
    var fire: EUDFuncPtr (1, 0);
    var baseDamage;
    var radius;
    var cooldown;
};

function getTrap(id): TrapType {
    return TRAP_OBJ[id];
}

function isTrapValid(id) {
    return getTrap(id) != 0 && id < TRAP_COUNT;
}

function addTrap(Trap : TrapType, id) {
    Trap.id = id;
    TRAP_OBJ[id] = Trap;
}

function addTrapObj(id, spriteImageID, projectileImageID, fireFunction, baseDamage, radius, cooldown) {
    const trap = TrapType.alloc();
    trap.spriteImageID = spriteImageID;
    trap.projectileImageID = projectileImageID;
    trap.fire = fireFunction;
    trap.baseDamage = baseDamage;
    trap.radius = radius;
    trap.cooldown = cooldown;
    addTrap(trap, id);
}

function loadTraps() {

    const defaultFire = EUDFuncPtr (1, 0) (function(unit) {
        const trap = getTrap(Unit.getCustomValue(unit));
        if (Unit.getGroundWeaponCooldown(unit) > 0) {
            Unit.setGroundWeaponCooldown(unit, Unit.getGroundWeaponCooldown(unit) - 1);
            return;
        }

        Utils.centerLocationOnUnit($L("Trap"), unit, trap.radius, trap.radius);
        var hit = false;
        foreach(ptr, enemyUnit : EUDLoopPlayerUnit($P7)) {
            if (Utils.CUnitInLocation(enemyUnit, $L("Trap"))) {
                hit = true;
                if (trap.baseDamage != 0) {
                    Unit.damage(enemyUnit, trap.baseDamage);
                }
                // if (effect != 0) {Unit.setTopSpeed(enemyUnit, Unit.getOriginalTopSpeed(enemyUnit) / 4); }
            }
        }
        if (hit) {
            Utils.createImageSpriteAtUnitPosition(trap.projectileImageID, unit);
        }
        Unit.setGroundWeaponCooldown(unit, trap.cooldown);
    });

    addTrapObj(
        0,
        Const.Image_Stasis_Field_Hit,
        Const.Image_Hallucination_Death3,
        defaultFire,
        34,
        64,
        18
    );

    addTrapObj(
        1,
        Const.Image_Maelstrom_Hit,
        Const.Image_Flames1_Type2_Large,
        defaultFire,
        24,
        64,
        8
    );

    addTrapObj(
        2,
        Const.Image_Egg_Spawn,
        Const.Image_Sunken_Colony_Tentacle,
        defaultFire,
        34,
        64,
        18
    );

    addTrapObj(
        3,
        Const.Image_Venom_Hit_Unused,
        Const.Image_Infested_Terran_Explosion,
        defaultFire,
        34,
        64,
        18
    );

    addTrapObj(
        5,
        Const.Image_EMP_Shockwave_Hit_Part1,
        Const.Image_Subterranean_Spines,
        defaultFire,
        34,
        64,
        18
    );

    addTrapObj(
        7,
        Const.Image_Hallucination_Hit,
        Const.Image_Psionic_Shockwave_Hit,
        defaultFire,
        34,
        64,
        18
    );

    addTrapObj(
        8,
        Const.Image_Ensnare_Overlay_Large,
        Const.Image_Ensnare_Overlay_Medium,
        defaultFire,
        34,
        64,
        18
    );

    addTrapObj(
        9,
        Const.Image_Explosion1_Small,
        Const.Image_Unused_Heal_Medium,
        defaultFire,
        34,
        64,
        18
    );
}